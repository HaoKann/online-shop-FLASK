{% extends 'base.html' %}

{% block content %}
<div class="container py-5">
    <h1 class="text-center mb-5">Ваша корзина</h1>

    {% if not current_user.cart or current_user.cart.products_in_cart.count() == 0 %}
        <div class="text-center py-5">
            <i class="bi bi-cart-x" style="font-size: 5rem; color: #444;"></i>
            <p class="h4 mt-3 text-muted">В корзине пока пусто</p>
            <a class="btn btn-primary btn-lg mt-4" href="{{ url_for('catalog.catalog') }}">Перейти в каталог</a>
        </div>
    {% else %}
        <div class="row gx-5">
            {# Блок товаров #}
            <div class="col-lg-8">
                <div class="cart-items-container">
                    {% for item in current_user.cart.products_in_cart %}
                        {% if item.amount > 0 %}
                            <div class="cart-item-card d-flex align-items-center mb-3 p-3 shadow-sm" data-product-id="{{ item.id }}" style="background-color: #1e1e1e; border-radius: 12px; border: 1px solid #333;">
                                <img src="{{ item.product.get_first_photo() }}" alt="{{ item.product.name }}" class="cart-item-img" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;">
                                
                                <div class="cart-item-details ms-3 flex-grow-1">
                                    <a href="{{ url_for('catalog.show_prod_details', prod_id=item.product.id) }}" class="cart-item-title text-decoration-none text-white fw-bold">{{ item.product.name }}</a>
                                    <div class="cart-item-price-single text-muted small">{{ "{:,.0f}".format(item.product.get_discount_price()).replace(",", " ") }} ₸ / шт.</div>
                                </div>

                                <div class="cart-item-quantity d-flex align-items-center bg-dark rounded px-2">
                                    <button class="btn btn-sm text-light quantity-change-btn" data-action="decrease" data-product-id="{{ item.id }}"><i class="bi bi-dash"></i></button>
                                    <span id="quantity-{{ item.id }}" class="quantity-value mx-3 fw-bold">{{ item.amount }}</span>
                                    <button class="btn btn-sm text-light quantity-change-btn" data-action="increase" data-product-id="{{ item.id }}"><i class="bi bi-plus"></i></button>
                                </div>

                                <div id="item-total-{{ item.id }}" class="cart-item-total fw-bold mx-4" style="color: #28a745;">
                                    {{ "{:,.0f}".format(item.product.get_discount_price() * item.amount).replace(",", " ") }} ₸
                                </div>

                                <button class="btn btn-link text-danger delete-btn p-0" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal" data-product-id="{{ item.id }}" title="Удалить товар">
                                    <i class="bi bi-x-lg fs-5"></i>
                                </button>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>

            {# Блок итогов (Липкий) #}
            <div class="col-lg-4">
                <div class="cart-summary-card p-4 shadow-sm" style="background-color: #1e1e1e; border-radius: 12px; position: sticky; top: 100px; border: 1px solid #333;">
                    <h4 class="mb-4">Итоги заказа</h4>
                    <div class="d-flex justify-content-between mb-3 text-light">
                        <span>Сумма товаров:</span>
                        <span id="cart-total-sum" class="fw-bold">{{ "{:,.0f}".format(current_user.cart.sum_of_products_in_cart()).replace(",", " ") }} ₸</span>
                    </div>
                    <div class="d-flex justify-content-between mb-4 text-light">
                        <span>Доставка:</span>
                        <span class="text-success">Бесплатно</span>
                    </div>
                    <hr class="border-secondary">
                    <div class="d-flex justify-content-between fw-bold fs-5 mt-3 text-light">
                        <span>Всего к оплате:</span>
                        <span id="cart-grand-total" class="fs-4">{{ "{:,.0f}".format(current_user.cart.sum_of_products_in_cart()).replace(",", " ") }} ₸</span>
                    </div>
                    <div class="d-grid mt-4">
                        <a class="btn btn-primary btn-lg shadow-sm" href="{{ url_for('user_order.checkout') }}">Оформить заказ</a>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    {# Модальное окно #}
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background-color: #2a2a2a; color: white;">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Подтверждение удаления</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    Вы уверены, что хотите удалить <strong id="productName"></strong> из корзины?
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Удалить</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const csrfToken = document.querySelector("meta[name='csrf-token']").getAttribute("content");
    
    // Логика изменения количества
    document.querySelectorAll('.quantity-change-btn').forEach(button => {
        button.addEventListener('click', function () {
            const productId = this.dataset.productId;
            const action = this.dataset.action;
            const url = action === 'increase' 
                ? `{{ url_for('cart.increase_amount', product_id=0) }}`.replace('0', productId)
                : `{{ url_for('cart.decrease_amount', product_id=0) }}`.replace('0', productId);

            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById(`quantity-${productId}`).textContent = data.new_quantity;
                    document.getElementById(`item-total-${productId}`).textContent = data.item_total.toLocaleString('ru-RU') + ' ₸';
                    document.getElementById('cart-total-sum').textContent = data.cart_total.toLocaleString('ru-RU') + ' ₸';
                    document.getElementById('cart-grand-total').textContent = data.cart_total.toLocaleString('ru-RU') + ' ₸';
                } else if (data.status === 'removed') {
                    location.reload();
                }
            });
        });
    });

    // Логика удаления
    const confirmDeleteModal = document.getElementById('confirmDeleteModal');
    if (confirmDeleteModal) {
        let productIdToDelete = null;
        confirmDeleteModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            productIdToDelete = button.getAttribute('data-product-id');
            document.getElementById('productName').textContent = button.closest('.cart-item-card').querySelector('.cart-item-title').textContent;
        });

        document.getElementById('confirmDeleteBtn').addEventListener('click', function () {
            fetch(`{{ url_for('cart.delete_products', product_id=0) }}`.replace('0', productIdToDelete), {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            }).then(() => location.reload());
        });
    }
});
</script>
{% endblock %}