<!-- Задача: Дать клиенту безопасное "окошко" для ввода данных карты и, 
 используя полученный client_secret, завершить платеж. -->

<!-- 1. Инициализация:  Подключаем библиотеку Stripe.js. -->

<!-- 2. Получение "разрешения": Скрипт сразу же обращается к бэкенду (/create-payment-intent) 
 и получает тот самый client_secret. -->

<!-- 3. Создание формы: JavaScript говорит библиотеке Stripe: 
 "Используя это разрешение (clientSecret), создай поля для ввода карты и помести их в наш контейнер #payment-element". 
 Stripe.js создает iframe — полностью изолированное и защищенное окно, которое встроено в страницу. Сайт не имеет доступа к тому, что вводится в эти поля. -->

<!-- Нажатие на кнопку "Оплатить": -->
<!-- 4. Подтверждение платежа: Когда клиент нажимает "Оплатить", JavaScript выполняет главную команду stripe.confirmPayment(). 
Это значит что Stripe js берет данные из формы и проводит платеж, перед этим получая client_secret для подтверждения 
Данные карты идут напрямую в Stripe минуя сервер
Если client_secret совпадает с той операцией, который подготовил Stripe до этого - деньги списываются -->

<!-- 5. Результат: Если все успешно, Stripe перенаправляет пользователя на указанный return_url.
Если есть ошибка (неверный номер карты, нехватка средств), Stripe возвращает эту ошибку, и JavaScript показывает ее клиенту. -->

<!-- Таким образом, безопасно принимается платежи, а вся "грязная" работа с картами происходит на стороне Stripe.-->

{% extends 'base.html' %}

{% block scripts %}
    {{ super() }}
    <script src="https://js.stripe.com/v3/"></script>
{% endblock %}

{% block content %}
<div class="container py-5">
    <h1 class="text-center mb-5">Оформление и оплата</h1>
    
    <div class="row g-5 justify-content-center">
        {# Блок заказа #}
        <div class="col-lg-7">
            {# Основной контейнер для состава заказа #}
            <div class="p-4 shadow-sm payment-section">
                <h4 class="mb-4">Состав вашего заказа</h4>
                
                <div class="d-flex flex-column gap-3">
                    {% for item in current_user.cart.products_in_cart.all() %}
                        <div class="d-flex align-items-center p-3 order-item">
                            <img src="{{ item.product.get_first_photo() }}" alt="{{ item.product.name }}" style="width: 70px; height: 70px; object-fit: cover; border-radius: 8px;">
                            
                            <div class="ms-4 flex-grow-1">
                                <h6 class="mb-1 fw-bold ">{{ item.product.name }}</h6>
                                <small class="text-muted">{{ item.amount }} шт. × {{ "{:,.0f}".format(item.product.get_discount_price()).replace(",", " ") }} ₸</small>
                            </div>
                            
                            <div class="fw-bold">
                                {{ "{:,.0f}".format(item.amount * item.product.get_discount_price()).replace(",", " ") }} ₸
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <div class="d-flex justify-content-between fs-4 fw-bold mt-4 pt-3 border-top border-secondary px-2">
                    <span>Итого:</span>
                    <span class="text-success">{{ "{:,.0f}".format(current_user.cart.sum_of_products_in_cart()).replace(",", " ") }} ₸</span>
                </div>
            </div>

            {# Кнопка теперь внутри col-lg-7 #}
            <div class="text-start mt-4">
                <a href="{{ url_for('cart.user_cart') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-2"></i> Вернуться в корзину
                </a>
            </div>
        </div>

        {# Блок оплаты #}
        <div class="col-lg-5">
            <div class="p-4 shadow-sm payment-section sticky-payment">
                <h4 class="mb-4 ">Оплата заказа</h4>
                <form id="payment-form">
                    {{ form.csrf_token }}

                    <div id="payment-element" class="mb-4"></div>
                    
                    <button id="submit-button" class="btn btn-primary btn-lg w-100" type="submit">
                        <div class="spinner-border spinner-border-sm d-none me-2" id="spinner" role="status"></div>
                        <span id="button-text">Оплатить {{ "{:,.0f}".format(current_user.cart.sum_of_products_in_cart()).replace(",", " ") }} ₸</span>
                    </button>
                    
                    <div id="payment-message" class="alert alert-danger mt-3 d-none" role="alert"></div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    const paymentForm = document.getElementById("payment-form");
    const submitButton = document.getElementById("submit-button");
    const spinner = document.getElementById("spinner");
    const buttonText = document.getElementById("button-text");
    const messageContainer = document.getElementById("payment-message");

    // 1. Определяем тему (проверяем наличие класса на body или html)
    const isDark = document.body.classList.contains("dark") || 
                   document.body.classList.contains("dark-theme") || 
                   document.documentElement.classList.contains("dark");

    // 2. Настройка внешнего вида Stripe
    // Мы используем 'night' для темной темы и 'stripe' для светлой
    // И обязательно используем RULES для принудительной покраски текста
    const appearance = {
        theme: isDark ? 'night' : 'stripe',
        variables: {
            colorPrimary: '#600018',
            colorBackground: isDark ? '#1e1e1e' : '#ffffff',
            colorText: isDark ? '#ffffff' : '#000000',
            colorDanger: '#dc3545',
            borderRadius: '8px',
        },
        rules: {
            // Принудительно задаем цвета для полей ввода
            '.Input': {
                color: isDark ? '#ffffff' : '#000000',
                backgroundColor: isDark ? '#252525' : '#ffffff',
                border: isDark ? '1px solid #444' : '1px solid #ced4da'
            },
            // Принудительно задаем цвета для подписей полей
            '.Label': {
                color: isDark ? '#ffffff' : '#600018'
            },
            // Цвет для текста подсказок (placeholder)
            '.Input::placeholder': {
                color: isDark ? '#888' : '#777'
            }
        }
    };

    const stripe = Stripe("{{ stripe_publishable_key }}");

    let elements;
    try {
        const csrfInput = document.querySelector("input[name='csrf_token']");
        const csrfToken = csrfInput ? csrfInput.value : '';

        const response = await fetch('/create-payment-intent', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json', 
                'X-CSRFToken': csrfToken 
            },
        });

        if (!response.ok) throw new Error('Ошибка связи с платежной системой.');
        
        const { clientSecret } = await response.json();
        
        elements = stripe.elements({ clientSecret, appearance });
        const paymentElement = elements.create("payment");
        paymentElement.mount("#payment-element");
    } catch (error) {
        if (messageContainer) {
            messageContainer.textContent = 'Ошибка загрузки платежной формы.';
            messageContainer.classList.remove('d-none');
        }
    }

    // Обработка отправки формы
    paymentForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        
        submitButton.disabled = true;
        spinner.classList.remove("d-none");
        buttonText.classList.add("d-none");

        const { error } = await stripe.confirmPayment({
            elements,
            confirmParams: { 
                return_url: "{{ url_for('user_order.order_success', _external=True) }}" 
            },
        });

        if (error) {
            if (messageContainer) {
                messageContainer.textContent = error.message;
                messageContainer.classList.remove("d-none");
            }
            submitButton.disabled = false;
            spinner.classList.add("d-none");
            buttonText.classList.remove("d-none");
        }
    });
});
</script>
{% endblock %}