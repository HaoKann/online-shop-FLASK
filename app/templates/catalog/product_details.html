{% extends 'base.html' %}

{% block content %}
<div class="product-page-container mb-5">
    {# --- Галерея --- #}
    <div class="product-page-gallery">
        <div id="productCarousel" class="carousel slide" data-bs-ride="false">
            <div class="carousel-inner border rounded shadow-sm bg-white">
                {% if product.photos.count() > 0 %}
                    {% for photo in product.photos %}
                        <div class="carousel-item {% if loop.first %}active{% endif %}">
                            <div style="height: 500px;">
                                <img src="{{ photo.get_photo() }}"
                                    class="d-block w-100 h-100 object-fit-contain p-3"
                                    alt="{{ product.name }}">
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="carousel-item active">
                        <div style="height: 500px;">
                            <img src="{{ product.get_first_photo() }}"
                                class="d-block w-100 h-100 object-fit-contain p-3"
                                alt="Нет фото">
                        </div>
                    </div>
                {% endif %}
            </div>

            {% if product.photos.count() > 1 %}
                <button class="carousel-control-prev" type="button"
                        data-bs-target="#productCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon"></span>
                </button>
                <button class="carousel-control-next" type="button"
                        data-bs-target="#productCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon"></span>
                </button>
            {% endif %}
        </div>

        {% if product.photos.count() > 1 %}
            <div class="product-page-thumbnails d-flex gap-2 mt-3 overflow-auto pb-2">
                {% for photo in product.photos %}
                    <div class="thumb-item {% if loop.first %}active{% endif %}"
                        data-bs-target="#productCarousel"
                        data-bs-slide-to="{{ loop.index0 }}"
                        style="width:80px; height:80px; min-width:80px; cursor:pointer;">
                        <img src="{{ photo.get_photo() }}"
                            class="w-100 h-100 object-fit-cover rounded"
                            alt="thumb">
                        <div class="thumb-overlay"></div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>

    {# --- Инфо-блок --- #}
    <div class="product-page-info">
        <span class="product-page-category">{{ product.category.name }}</span>
        
        <div class="d-flex align-items-center flex-wrap gap-3 mb-2">
            <h1 class="product-page-title mb-0">{{ product.name }}</h1>
            {% if (average_rating | default(0)) > 0 %}
                <div class="stars-container d-flex align-items-center">
                    <div class="text-warning d-flex align-items-center" style="white-space: nowrap; font-size: 1.1rem;">
                        <span class="fw-bold me-1">{{ average_rating | round(1) }}</span>
                        <i class="bi bi-star-fill"></i>
                    </div>
                    <span class="rating-count ms-2">({{ reviews_count }})</span>
                </div>
            {% endif %}
        </div>

        <div class="product-page-price-block">
            {% if product.discount %}
                <span class="old-price">{{ "{:,.0f}".format(product.price).replace(",", " ") }} ₸</span>
                <span class="current-price-discount">{{ "{:,.0f}".format(product.get_discount_price()).replace(",", " ") }} ₸</span>
                <span class="discount-badge">-{{ product.discount }}%</span>
            {% else %}
                <span class="current-price">{{ "{:,.0f}".format(product.price).replace(",", " ") }} ₸</span>
            {% endif %}
        </div>

        <div class="product-page-actions">
            <a href="{{ url_for('cart.add_products', product_id=product.id) }}" class="btn btn-primary btn-lg">
                <i class="bi bi-cart-plus-fill"></i> Добавить в корзину
            </a>
            <a href="{{ url_for('favourites.add_to_favourites', product_id=product.id) }}" class="btn btn-icon" title="Добавить в избранное">
                <i class="bi bi-heart"></i>
            </a>
        </div>

        {# --- БЛОК С ХАРАКТЕРИСТИКАМИ (ИСПРАВЛЕННЫЙ) --- #}
        <div class="product-page-specs mt-4">
            <h5 class="specs-title mb-3 pb-2 border-bottom border-secondary border-opacity-25">Характеристики</h5>
            
            {% if required_specs %}
                <div class="specs-list d-flex flex-column">
                    {% for spec_template in required_specs %}
                        <div class="row py-2 border-bottom border-secondary border-opacity-10 align-items-center">
                            {# Левая колонка: Название (серое) #}
                            <div class="col-sm-4">
                                <span class="text-secondary small text-uppercase fw-semibold">
                                    {{ spec_template.name }}
                                </span>
                            </div>
                            
                            {# Правая колонка: Значение (Адаптивный цвет) #}
                            <div class="col-sm-8 text-end">
                                {# УБРАЛИ class="text-white", заменили на fw-bold #}
                                {# Цвет теперь будет браться из body или родителя #}
                                <span class="fw-bold text-break">
                                    {{ spec_values.get(spec_template.name, '-') }}
                                </span>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-muted">Характеристики не указаны.</p>
            {% endif %}
        </div>
        {# --- КОНЕЦ БЛОКА --- #}
    </div>
</div>

<hr class="border-secondary opacity-25">

{# --- СЕКЦИЯ ОТЗЫВОВ --- #}
<div class="container py-5">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <h2 class="mb-4"><i class="bi bi-chat-left-text me-2"></i> Отзывы покупателей</h2>

            {# Форма добавления отзыва #}
            <div class="card admin-card p-4 mb-5">
                {% if current_user.is_authenticated %}
                    <h5 class="card-title mb-3">Оставить отзыв</h5>
                    <form method="POST" action="{{ url_for('catalog.show_prod_details', prod_id=product.id) }}">
                        {{ form.hidden_tag() }}
                        <div class="mb-3">
                            <label class="form-label d-block">Ваша оценка</label>
                            <div class="rating-area">
                                {% for i in range(5, 0, -1) %}
                                    <input type="radio" id="star-{{ i }}" name="rating" value="{{ i }}" required>
                                    <label for="star-{{ i }}" title="Оценка {{ i }}"></label>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Текст отзыва</label>
                            {{ form.text(class="form-control", rows="4") }}
                        </div>
                        <button type="submit" class="btn btn-primary">Отправить на модерацию</button>
                    </form>
                {% else %}
                    <div class="text-center py-3">
                        <p class="mb-3">Войдите, чтобы оставить отзыв</p>
                        <a href="{{ url_for('auth.login') }}" class="btn btn-outline-light btn-sm" style="color: var(--accent); border-color: var(--accent);">Войти</a>
                    </div>
                {% endif %}
            </div>

            {# Список отзывов #}
            <div class="reviews-list">
                {% if approved_reviews %}
                    {% for review in approved_reviews %}
                        <div class="review-item mb-4 pb-4 border-bottom border-secondary border-opacity-25">
                            <div class="d-flex justify-content-between mb-2">
                                <div>
                                    <strong class="d-block">{{ review.user.name }}</strong>
                                    <div class="text-warning small">
                                        {% for i in range(review.rating) %}<i class="bi bi-star-fill"></i>{% endfor %}
                                        {% for i in range(5 - review.rating) %}<i class="bi bi-star text-muted"></i>{% endfor %}
                                    </div>
                                </div>
                                <small class="text-muted">{{ review.date_posted.strftime('%d.%m.%Y') }}</small>
                            </div>
                            <p class="mb-0">{{ review.text }}</p>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-chat-dots fs-1 text-muted d-block mb-2"></i>
                        <p class="text-muted">Пока нет отзывов. Станьте первым!</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const carouselElement = document.getElementById('productCarousel');
    const thumbnails = document.querySelectorAll('.thumb-item');

    carouselElement.addEventListener('slide.bs.carousel', function (event) {
        const nextIndex = event.to;
        thumbnails.forEach(thumb => thumb.classList.remove('active'));
        if (thumbnails[nextIndex]) {
            thumbnails[nextIndex].classList.add('active');
        }
    });
});
</script>
{% endblock %}